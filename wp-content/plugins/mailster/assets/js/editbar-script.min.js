mailster=function(A,q,ie,i){"use strict";var e={},T=A.$.editbar,j,n={img:0,single:80,multi:0,btn:0,auto:0,codeview:0},D=T.find(".imagepreview"),N=T.find(".imagewidth"),E=T.find(".imageheight"),H=T.find(".imagecrop"),$=T.find(".factor"),C=T.find(".highdpi"),L=T.find(".original"),O=T.find(".imagelink"),I=T.find(".imageurl"),R=T.find(".orgimageurl"),z=T.find(".imagealt"),W=T.find(".singlelink"),S=T.find(".buttonlink"),B=T.find(".buttonlabel"),J=T.find(".buttonalt"),ne=T.find(".button-nav"),r=T.find("ul.buttons"),V,U,F,K,Q,M,G,P,l,s,o,d,c,X="",m=false,re=q("#post-search"),le=q("#image-search"),f=q('[name="image-search-type"]');T.on("keyup change","input.live",y).on("keyup change","#mailster-editor",y).on("click",".replace-image",g).on("change",".highdpi",v).on("click","button.save",t).on("click",".cancel",w).on("click","a.remove",_).on("click","a.reload",te).on("click","a.single-link-content",pe).on("click","a.add_image",be).on("click","a.add_image_url",ve).on("click",".imagelist li",de).on("dblclick",".imagelist li",t).on("change","#post_type_select input",te).on("click",".postlist li",ce).on("click",".load-more-posts",fe).on("click","a.btnsrc",k).on("click",".imagepreview",x).on("click","a.nav-tab",se).on("change","select.check-for-posts",b).on("change paste","#dynamic_rss_url",b).on("keyup change","#post-search",ue).on("keyup change","#image-search",ue).on("change",'[name="image-search-type"]',ue).on("mouseenter","#wp-mailster-editor-wrap, .imagelist, .postlist, .CodeMirror",h).on("mouseleave","#wp-mailster-editor-wrap, .imagelist, .postlist, .CodeMirror",u).on("click",".current-tag a",false).on("keypress.mailster",function(e){if(e.keyCode==13&&e.target.nodeName.toLowerCase()!="textarea")return false}).on("keyup.mailster",function(e){switch(e.keyCode){case 27:w();return false;break;case 13:if(F.type!="multi"&&F.type!="codeview"){t();return false}break}});q(".imagelist, .postlist").on("scroll",A.util.throttle(he,500));A.util.getRealDimensions(A.$.iframe.contents().find("img").eq(0),function(e,t,a){var i=a>=1.5;$.val(a);C.prop("checked",i);i?T.addClass("high-dpi"):T.removeClass("high-dpi")});ne.on("click","a",function(){q(this).parent().find("a").removeClass("nav-tab-active");q(this).parent().parent().find("ul.buttons").hide();var e=q(this).addClass("nav-tab-active").attr("href");q("#tab-"+e.substr(1)).show();return false});I.on("paste change",function(a){var i=q(this);setTimeout(function(){var e=Y(i.val()),t=new Image;if(e){Z();t.onload=function(){D.attr("src",e);K={width:F.width||t.width,height:Math.round((F.width||t.width)/(t.width/t.height)),asp:t.width/t.height};E.val(K.height);Z(false)};t.onerror=function(){if(a.type!="paste")alert(A.util.sprintf(A.l10n.campaigns.invalid_image,'"'+e+'"'))};t.src=e}},1)});N.on("keyup change",function(){if(!H.is(":checked"))E.val(Math.round(N.val()/K.asp));ee()});E.on("keyup change",function(){if(!H.is(":checked"))N.val(Math.round(E.val()*K.asp));ee()});H.on("change",function(){if(!H.is(":checked")){E.val(Math.round(N.val()/K.asp));H.parent().removeClass("not-cropped")}else{H.parent().addClass("not-cropped")}ee()});q("#dynamic_embed_options_post_type").on("change",function(){var t=q("#dynamic_embed_options_cats"),e=q(this).val();t.find("select").prop("disabled",true);T.find(".dynamic-rss")[e=="rss"?"show":"hide"]();Z();A.util.ajax("get_post_term_dropdown",{posttype:e},function(e){Z(false);if(e.success){t.html(e.data.html);if(M&&M.terms){var r=t.find(".dynamic_embed_options_taxonomy_wrap");q.each(M.terms,function(n,e){if(!e)return;var t=e.split(",");q.each(t,function(e,t){var a=r.eq(n).find("select").eq(e),i;if(!a.length){i=r.eq(n).find("select").last();a=i.clone();a.insertAfter(i);q("<span> "+A.l10n.campaigns.or+" </span>").insertBefore(a)}a.val(t)})});q.fn.select2&&q("#dynamic_embed_options_cats").find("select").select2()}}b()},function(e,t,a){Z(false)})});A.events.documentReady.push(function(){T.draggable&&T.draggable({distance:20,axis:"y"});if(A.util.isTinyMCE&&tinymce.get("mailster-editor")){if(tinymce.majorVersion>=4){tinymce.get("mailster-editor").on("keyup",function(){a(this)});tinymce.get("mailster-editor").on("ExecCommand",function(){a(this)})}else{tinymce.get("mailster-editor").onKeyUp.add(function(){a(this)});tinymce.get("mailster-editor").onExecCommand.add(function(){a(this)})}}});function h(){p(false)}function u(){p(true)}function p(e){if(T.draggable){if(e!==false){T.draggable("enable")}else{T.draggable("disable")}}}function se(e,t){var a;if(typeof e=="string"){a=j.find('a[href="'+e+'"]')}else{a=q(this);e=a.attr("href")}a.parent().find("a.nav-tab").removeClass("nav-tab-active");a.addClass("nav-tab-active");j.find(".tab").hide();j.find(e).show();if(e=="#dynamic_embed_options"&&t!==false)q("#dynamic_embed_options_post_type").trigger("change");if(e=="#image_button")U="image";if(e=="#text_button")U="text";P=j.find(e).find(".postlist").eq(0);return false}function g(){Z();var e=$.val(),t=F.element.width(),a=Math.round(t/1.6),i=q("<img>",{src:"https://dummy.mailster.co/"+t*e+"x"+a*e+".jpg",alt:F.content,label:F.content,width:t,height:a,border:0,editable:F.content});i[0].onload=function(){i.attr({width:t,height:a}).removeAttr("style");ae()};if(F.element.parent().is("a"))F.element.unwrap();if(!F.element.parent().is("td"))F.element.unwrap();F.element.replaceWith(i);return false}function v(){if(q(this).is(":checked")){$.val(2);T.addClass("high-dpi")}else{$.val(1);T.removeClass("high-dpi")}}function b(){clearInterval(s);Z();s=setTimeout(function(){var e=T.find("#dynamic_embed_options_post_type").val(),t=T.find("#dynamic_embed_options_content").val(),a=T.find("#dynamic_embed_options_relative").val(),i=T.find(".dynamic_embed_options_taxonomy_wrap"),n=q("#dynamic_rss_url").val(),r={},l=[];q.each(i,function(e){var t=q(this).find("select"),a=[];q.each(t,function(){var e=parseInt(q(this).val(),10);if(e!=-1&&q.inArray(e,a)==-1&&!isNaN(e))a.push(e)});a=a.join(",");if(a)l[e]=a});r={id:A.campaign_id,post_type:e,relative:a,extra:l,content:t,modulename:F.name,expect:F.elements.expects,rss_url:n};if(JSON.stringify(r)===JSON.stringify(o)){Z(false);return}q("#dynamic_embed_options").find("h4.current-match").html("&hellip;");q("#dynamic_embed_options").find("div.current-tag").html("&hellip;");if("rss"==e&&!n){Z(false);return}o=r;A.util.ajax("check_for_posts",r,function(e){Z(false);if(e.success){Q=e.data.pattern;q("#dynamic_embed_options").find("h4.current-match").html(e.data.title);q("#dynamic_embed_options").find("div.current-tag").text(e.data.pattern.title+"\n\n"+e.data.pattern[t])}},function(e,t,a){Z(false)})},500)}function Y(e,t,a,i,n){t=t||N.val();a=a||E.val()||Math.round(t/1.6);i=typeof i=="undefined"?H.prop(":checked"):i;n=typeof n=="undefined"?L.prop(":checked"):n;if(/^\{(.+)\}$/.test(e)){var r=$.val();e=A.ajaxurl+"?action=mailster_image_placeholder&tag="+e.replace("{","").replace("}","")+"&w="+Math.abs(t)+"&h="+Math.abs(a)+"&c="+(i?1:0)+"&o="+(n?1:0)+"&f="+r}return e}function oe(e){if(-1!==e.indexOf("?action=mailster_image_placeholder&tag=")){var t=e.match(/&tag=([a-z0-9-_,;:|~]+)&/);return"{"+t[1]+"}"}return false}function y(e){if((e.keyCode||e.which)!=27&&F)F.element.html(q(this).val())}function Z(e){if(e===false){q("#editbar-ajax-loading").hide();T.find(".buttons").find("button").prop("disabled",false);m=false}else{m=true;q("#editbar-ajax-loading").css("display","inline");T.find(".buttons").find("button").prop("disabled",true)}}function t(){if(F.type=="img"){var n=F.element.is("img");if(I.val()){K={id:null,name:"",src:Y(I.val()),width:K.width,height:K.height,asp:K.width/K.height}}if(K){Z();var r=$.val()||1,e=N.val(),t=E.val(),l=H.is(":checked"),s=L.is(":checked"),o=n?"src":"background",a;F.element.attr({"data-id":K.id}).data("id",K.id).addClass("mailster-loading");if(n){F.element.attr({src:K.src,alt:K.name});if(!F.is_percentage){F.element.attr("width",Math.round(e))}if(F.element.attr("height")&&F.element.attr("height")!="auto"){F.element.attr("height",Math.round(t))}if(l){F.element.attr({"data-crop":true}).data("crop",true)}if(s){F.element.attr({"data-original":true}).data("original",true)}}if(K.src){F.element.attr(o,K.src);if(a=F.element.attr("style")){F.element.attr("style",a.replace(/url\("?(.+)"?\)/,"url('"+K.src+"')"))}}A.util.ajax("create_image",{id:K.id,original:s,src:K.src,width:e*r,height:t*r,crop:l},function(t){Z(false);if(t.success){D.attr("src",t.data.image.url);t.data.image.width=(t.data.image.width||K.width)/r;t.data.image.height=t.data.image.width/K.asp;t.data.image.asp=K.asp;K=t.data.image;K.name=z.val();if(n){F.element.one("load error",function(e){if("error"==e.type){alert(A.util.sprintf(A.l10n.campaigns.invalid_image,t.data.image.url))}F.element.removeClass("mailster-loading");A.trigger("save")});F.element.attr({alt:K.name});if(!F.is_percentage){F.element.attr("width",Math.round(N.val()))}if(F.element.attr("height")&&F.element.attr("height")!="auto"){F.element.attr("height",Math.round(E.val()))}if(l){F.element.attr({"data-crop":true}).data("crop",true)}if(s){F.element.attr({"data-original":true}).data("original",true)}}else{F.element.removeClass("mailster-loading");var e=F.element.html(),a=e.match(/<modules/),i;if(R.val()){if(a){if(a=e.match(new RegExp("<v:background(.*)</v:background>","s"))){F.element.html(A.util.replace(e,a[0],A.util.replace(a[0],R.val(),K.url)))}}else{F.element.html(A.util.replace(e,R.val(),K.url));F.element.find("single, multi").removeAttr("id")}}}F.element.removeAttr(o).attr(o,K.url)}else{F.element.removeClass("mailster-loading")}z.val("");ae()},function(e,t,a){Z(false)})}else{F.element.attr({alt:z.val()});ae()}if(F.element.parent().is("a"))F.element.unwrap();var i=O.val();if(i)F.element.wrap('<a href="'+i+'"></a>');return false}else if(F.type=="btn"){var i=S.val();if(!i&&!confirm(A.l10n.campaigns.remove_btn))return false;var d=j.find("a.active").find("img").attr("src");if(typeof d=="undefined"){U="text";if(!B.val())B.val(A.l10n.campaigns.read_more)}F.element.removeAttr("tmpbutton");if("image"==U){var r=$.val();var c=new Image;c.onload=function(){if(!F.element.find("img").length){var e=F.element.closest(".textbutton");var t=q('<a href="" editable label="'+F.name+'"><img></a>');e.length?e.replaceWith(t):F.element.replaceWith(t);F.element=t}F.element.find("img").attr({src:d,width:Math.round((c.width||F.element.width())/r),height:Math.round((c.height||F.element.height())/r),alt:J.val()});i?F.element.attr("href",i):F.element.remove();ae()};c.src=d}else{var m=F.element.closest(".textbutton"),f=B.val();if(!m.length){var h=q(F.element[0].outerHTML);var u=A.util.trim(F.element.text());var p=F.element[0].innerHTML;var g=p.replace(u,f);var v=q(h.empty()[0].outerHTML).html(g).attr("href",i);F.element.replaceWith(v)}else{if(F.element[0]==m[0]){F.element=m.find("a")}F.element.text(f)}if(i){F.element.attr("href",i)}else{F.element.remove();m.remove()}ae()}return false}else if(F.type=="auto"){var b=q("#embedoption-bar").find(".nav-tab-active").data("type"),y=F.element.data("position")||0,_,w=[],k,x;F.element.removeAttr("data-tag data-rss").removeData("tag").removeData("data-rss");if("dynamic"==b){_=T.find("#dynamic_embed_options_content").val();k=T.find("#dynamic_embed_options_post_type").val();x=q("#dynamic_rss_url").val();Q.content=Q[_];F.element.attr("data-tag",Q.tag).data("tag",Q.tag);if("rss"==k){F.element.attr("data-rss",x).data("rss",x)}}else{_=q(".embed_options_content:checked").val();F.element.removeAttr("data-tag").removeData("tag")}if(Q){if(F.elements.single.length){F.elements.single.each(function(e,t){var a=q(this),i=a.attr("expect")||"title",n=Q[i]?Q[i]:"";if(Array.isArray(n).isArray)n=n[e];if(n&&!a.is("[ignore]"))a.html(n)})}if(F.elements.multi.length){F.elements.multi.each(function(e,t){var a=q(this),i=a.attr("expect")||_,n=Q[i]?Q[i]:"";if(Array.isArray(n))n=n[e];if(n&&!a.is("[ignore]"))a.html(n)})}if(Q.link){F.elements.buttons.each(function(e,t){var a=q(this),i=a.attr("expect")||"link",n=Q[i]?Q[i]:"";if(a.is("[ignore]"))return;if(n)a.attr("href",n);if(Q["button"])a.html(Q["button"])})}else{if(F.elements.buttons.parent().length&&F.elements.buttons.parent()[0].nodeName=="TD"){F.elements.buttons.closest(".textbutton").remove()}else if(F.elements.buttons.length){if(F.elements.buttons.last().find("img").length){F.elements.buttons.remove()}}}if(Q.image&&F.elements.images.length){Z();F.elements.images.each(function(e,t){var a=q(this),i=$.val(),n=a.attr("expect")||"image",r=Q[n];if("static"==b){if(!r){return false}if(typeof r=="string"){r={id:null,url:r}}A.util.ajax("create_image",{id:r.id,src:r.url,original:L.is(":checked"),width:a.width()*i,height:a.height()*i,crop:a.data("crop")},function(e){if(e.success){Z(false);if(L.is(":checked")){a.attr("data-original",true).data("original",true)}if("img"==a.prop("tagName").toLowerCase()){a.attr({"data-id":r.id,src:e.data.image.url,width:Math.round(e.data.image.width/i),alt:Q.alt||Q.title}).data("id",r.id);if(a.attr("height")&&a.attr("height")!="auto"){a.attr("height",Math.round(e.data.image.height/i))}if(a.parent().is("a")){a.unwrap()}if(Q.link){a.wrap('<a href="'+Q.link+'">')}}else{var t=a.attr("background");a.attr({"data-id":r.id,background:e.data.image.url}).data("id",Q[n].id);F.element.html(A.util.replace(F.element.html(),t,e.data.image.url));F.element.find("single, multi").removeAttr("id");A.trigger("save");A.trigger("refresh")}}},function(e,t,a){Z(false)});return false}else if("dynamic"==b){var l=a.width(),s=a.data("crop"),o=L.is(":checked"),d=s?a.height():null;if("img"==a.prop("tagName").toLowerCase()){a.removeAttr("data-id").attr({src:Y(Q[n],l,d,s,o),width:l,alt:Q.alt||Q.title}).removeData("id");if(a.attr("height")){a.attr("height",d||Math.round(l/1.6))}}else{var c=a.attr("background");a.removeAttr("data-id").attr({background:Y(Q[n],l)}).removeData("id");F.element.html(A.util.replace(F.element.html(),c,Y(Q[n],l,d,s,o)));F.element.find("single, multi").removeAttr("id")}}})}y=y+1>=F.areas.length?0:y+1;F.element.data("position",y);A.$.iframe.contents().find("html").find("img").each(function(){this.onload=function(){A.trigger("refresh")}})}}else if(F.type=="multi"){if(A.util.isTinyMCE&&tinymce.get("mailster-editor")&&!tinymce.get("mailster-editor").isHidden()){var C=tinymce.get("mailster-editor").getContent();C=C.replace('href="http://{','href="{');F.element.html(C)}}else if(F.type=="single"){if(F.conditions){F.aa="<if";q.each(q(".conditinal-area"),function(){F.aa=""})}if(F.element.parent().is("a"))F.element.unwrap();var i=W.val();if(i)F.element.wrap('<a href="'+i+'"></a>')}else if(F.type=="codeview"){var M=V.codemirror.getValue();F.element.html(M);F.modulebuttons.prependTo(F.element);F.element.attr("label",q("#module-name").val())}ae();return false}function _(){if(F.element.parent().is("a"))F.element.unwrap();if("btn"==F.type){var e=F.element.closest(".textbutton"),t=e.parent();if(!e.length){e=F.element}if(t.is("buttons")&&!t.find(".textbutton").length){t.remove()}else{e.remove()}}else if("img"==F.type&&"img"!=F.tag){F.element.attr("background","")}else{F.element.remove()}ae();return false}function w(){switch(F.type){case"img":case"btn":if(F.element.is("[tmpbutton]")){F.element.remove()}break;default:F.element.html(F.content);F.element.find("single, multi").removeAttr("id")}ae();return false}function k(){var e=q(this),t=e.data("link");j.find(".btnsrc").removeClass("active");e.addClass("active");J.val(e.attr("title"));if(t){var a;S.val(t);if((a=(t+"").indexOf("USERNAME",0))!=-1){S.trigger("focus");selectRange(S[0],a,a+8)}}return false}function x(){q(this).toggleClass("zoom")}function de(e,t){var a=t||q(this),i=a.data("id"),n=a.data("name"),r=a.data("src");if(!i)return;K={id:i,name:n,src:r};Z();j.find("li.selected").removeClass("selected");a.addClass("selected");if(F.element.data("id")==i){z.val(F.element.attr("alt"))}else if(F.element.attr("alt")!=n){z.val(n)}I.val("");D.attr("src","").on("load",function(){D.off("load");F.width=D.width();F.height=D.height();F.asp=a.data("asp")||F.width/F.height;K.asp=F.asp;Z(false);if(!H.is(":checked"))E.val(Math.round(N.val()/F.asp));ee()}).attr("src",r);return K}function ee(){var e=Math.round(.5*(F.height-F.width*(E.val()/N.val())))||0,t=parseInt($.val(),10);D.css({clip:"rect("+e+"px,"+F.width*t+"px,"+(F.height*t-e)+"px,0px)","margin-top":-1*e+"px"})}function ce(){var t=q(this),e=t.data("id"),a=t.data("name"),i=t.data("link"),n=t.data("thumbid");if(F.type=="btn"){S.val(i);J.val(a);j.find("li.selected").removeClass("selected");t.addClass("selected")}else if(F.type=="single"){W.val(i);j.find("li.selected").removeClass("selected");t.addClass("selected")}else{Z();A.util.ajax("get_post",{id:e,expect:F.elements.expects},function(e){Z(false);j.find("li.selected").removeClass("selected");t.addClass("selected");if(e.success){Q=e.data.pattern;j.find(".editbarinfo").html(A.l10n.campaigns.curr_selected+": <span>"+Q.title+"</span>")}},function(e,t,a){Z(false);j.find("li.selected").removeClass("selected")})}return false}function me(e){F=e;var o=e.element,d=o.closest("module"),t=m!="img"?e.offset.top:0,c=e.name||"",m=e.type,f=A.util.trim(o.html()),a=o.find("if"),h,u=F.element.data("position")||0,i,n,r,p=1;j=T.find("div.type."+m);T.addClass("current-"+m);F.width=o.width();F.height=o.height();F.asp=F.width/F.height;F.crop=o.data("crop")?o.data("crop"):false;F.tag=o.prop("tagName").toLowerCase();F.is_percentage=o.attr("width")&&o.attr("width").indexOf("%")!==-1;F.content=f;M=F.element.data("tag");X="";A.trigger("selectModule",d);if(a.length){h={if:null,elseif:[],else:null,total:0};h=[];T.addClass("has-conditions");i=j.find(".conditinal-area");n=T.find(".conditions").eq(0);n.clone().prependTo(i);q.each(a.find("elseif"),function(){var e=q(this),t=e.html();h.push({el:e,html:t,field:e.attr("field"),operator:e.attr("operator"),value:e.attr("value")});e.detach();i.clone().val(t).insertAfter(i)});q.each(a.find("else"),function(){var e=q(this),t=e.html();h.push({el:e,html:t});e.detach();i.clone().val(t).insertAfter(i)});h.unshift({el:a,html:a.html(),field:a.attr("field"),operator:a.attr("operator"),value:a.attr("value")})}else{T.removeClass("has-conditions")}F.conditions=h;if(m=="img"){L.prop("checked",F.original);H.prop("checked",F.crop).parent()[F.crop?"addClass":"removeClass"]("not-cropped");X=A.util.trim(le.val());$.val(1);A.util.getRealDimensions(o,function(e,t,a){var t=a>=1.5;$.val(a);C.prop("checked",t);t?T.addClass("high-dpi"):T.removeClass("high-dpi");p=a})}else if(m=="btn"){if(o.find("img").length){q("#button-type-bar").find("a").eq(1).trigger("click");var g=o.find("img").attr("src");if(ne.length){var l=T.find("img[src='"+g+"']");if(l.length){T.find("ul.buttons").hide();var s=l.parent().parent().parent();T.find('a[href="#'+s.attr("id").substr(4)+'"]').trigger("click")}else{q.each(T.find(".button-nav"),function(){q(this).find(".nav-tab").eq(0).trigger("click")})}}B.val(o.find("img").attr("alt"));A.util.getRealDimensions(o.find("img"),function(e,t,a){var t=a>=1.5;$.val(a);C.prop("checked",t);t?T.addClass("high-dpi"):T.removeClass("high-dpi");p=a})}else{q("#button-type-bar").find("a").eq(0).trigger("click");B.val(A.util.trim(o.text())).trigger("focus").trigger("select");S.val(F.element.attr("href"));T.find("ul.buttons").hide()}}else if(m=="auto"){se("#"+(M?"dynamic":"static")+"_embed_options",true);X=A.util.trim(re.val());if(M){var v=M.substr(1,M.length-2).split(":"),b=v[1].split(";"),y=b.shift(),_=b.length?b:null;M={post_type:v[0],relative:y,terms:_};q("#dynamic_embed_options_post_type").val(M.post_type).trigger("change");q("#dynamic_embed_options_relative").val(M.relative).trigger("change")}else{}}else if(m=="codeview"){var w=j.find("textarea"),k=o.clone(),x=A.editor.cleanHTML(o.html());F.modulebuttons=k.find("modulebuttons");w.show().html(x);q("#module-name").val(c)}r=A.$.template.offset().top+(F.offset.top-A.$.window.height()/2+F.height/2);r=Math.max(A.$.template.offset().top-200,r);A.util.scroll(r,function(){T.find("h4.editbar-title").html(c);T.find("div.type").hide();T.find("div."+m).show();if(d.data("rss"))q("#dynamic_rss_url").val(d.data("rss"));var e=A.util.top()+A.$.window.height()/2-A.$.template.offset().top-T.height()/2;T.css({top:e});Z();if(m=="single"){if(h){q.each(h,function(e,t){var a=j.find(".conditinal-area").eq(e);a.find("select.condition-fields").val(t.field);a.find("select.condition-operators").val(t.operator);a.find("input.condition-value").val(t.value);a.find("input.input").val(t.html)})}else{var t=f.replace(/&amp;/g,"&");W.val("");if(F.element.parent().is("a")){var a=F.element.parent().attr("href");W.val(a!="#"?a:"");pe()}else if(F.element.find("a").length){var i=F.element.find("a");if(t==i.text()){var a=i.attr("href");t=i.text();W.val(a!="#"?a:"")}}j.find("input").eq(0).val(A.util.trim(t))}}else if(m=="img"){var n=parseInt(o[0].style.maxWidth,10)||o.parent().width()||o.width()||null;var r=parseInt(o[0].style.maxHeight,10)||o.parent().height()||o.height()||null;var l=o.attr("src")||o.attr("background");var s=oe(l)||"";if(o.parent().is("a")){O.val(o.parent().attr("href").replace("%7B","{").replace("%7D","}"))}else{O.val("")}z.val(o.attr("alt"));I.val(s);R.val(l);o.data("id",o.attr("data-id"));q(".imageurl-popup").toggle(!!s);D.removeAttr("src").attr("src",l);G="attachment";P=j.find(".imagelist");K={id:o.data("id"),src:l,width:o.width()*p,height:o.height()*p};K.asp=K.width/K.height;te();ee()}else if(m=="btn"){J.val(o.find("img").attr("alt"));if(o.attr("href"))S.val(o.attr("href").replace("%7B","{").replace("%7D","}"));G="link";P=j.find(".postlist").eq(0);te();q.each(j.find(".buttons img"),function(){var e=q(this);e.css("background-color",o.css("background-color"));e.attr("src")==g?e.parent().addClass("active"):e.parent().removeClass("active")})}else if(m=="auto"){G="post";P=j.find(".postlist").eq(0);te();F.areas=F.element.find("[area]");if(!F.areas.length){F.areas=F.element}F.elements={single:F.areas.eq(u).find("single"),multi:F.areas.eq(u).find("multi"),buttons:F.areas.eq(u).find("a[editable]"),images:F.areas.eq(u).find("img[editable], td[background], th[background]"),expects:F.areas.eq(u).find("[expect]").map(function(){return q(this).attr("expect")}).toArray()};if(F.areas.length>1){T.find(".editbarposition").html(A.util.sprintf(A.l10n.campaigns.for_area,"#"+(u+1))).show()}else{T.find(".editbarposition").hide()}}else if(m=="codeview"){if(V){V.codemirror.clearHistory();V.codemirror.setValue("");j.find(".CodeMirror").remove()}}T.show(0,function(){if(m=="single"){T.find("input").trigger("focus").trigger("select")}else if(m=="img"){N.val(Math.round(F.width));E.val(Math.round(F.height));H.prop("checked",F.crop)}else if(m=="btn"){N.val(Math.round(n));E.val(Math.round(r))}else if(m=="multi"){q("#mailster-editor").val(f);if(A.util.isTinyMCE&&tinymce.get("mailster-editor")){tinymce.get("mailster-editor").setContent(f);tinymce.execCommand("mceFocus",false,"mailster-editor")}}else if(m=="codeview"){if(wp.codeEditor){V=wp.codeEditor.initialize(w,{codemirror:A.util.codemirrorargs})}else{V={codemirror:ie.CodeMirror.fromTextArea(w.get(0),A.util.codemirrorargs)}}}});Z(false)},100)}function te(e,t){var a=q("#post_type_select").find("input:checked").serialize(),i={type:G,posttypes:a,search:X,imagetype:f.filter(":checked").val(),offset:0};if(G=="attachment"){i.id=K.id}P.empty();Z();A.util.ajax("get_post_list",i,function(e){Z(false);if(e.success){l=e.data.itemcount;ge(e.data.html,true);t&&t()}},function(e,t,a){Z(false)})}function fe(){var t=q(this),e=t.data("offset"),a=t.data("type");Z();var i=q("#post_type_select").find("input:checked").serialize();A.util.ajax("get_post_list",{type:a,posttypes:i,search:X,imagetype:f.filter(":checked").val(),offset:e,itemcount:l},function(e){Z(false);if(e.success){l=e.data.itemcount;t.remove();ge(e.data.html,false)}},function(e,t,a){Z(false)});return false}function he(){var e=q(this);var t=e.scrollTop();var a=e.innerHeight();var i=this.scrollHeight;if(!m&&t+a>=i-15){e.find(".load-more-posts").click()}}function ue(){var e=q(this),t=A.util.trim("attachment"==G?le.val():re.val());if(!e.is(":checked")&&X==t){return false}X=t;clearTimeout(d);d=setTimeout(function(){te()},500)}function pe(){q("#single-link").slideDown(200);W.trigger("focus").trigger("select");G="link";P=j.find(".postlist").eq(0);te();return false}function ge(e,t,a){if(!a)a=P;if(t)a.empty();if(!a.html())a.html("<ul></ul>");a.find("ul").append(e)}function ve(){q(".imageurl-popup").toggle();if(!I.val()&&K.src.indexOf(location.origin)==-1&&K.src.indexOf("dummy.mailster.co")==-1){I.val(K.src)}I.trigger("focus").trigger("select");return false}function be(){if(!wp.media.frames.mailster_editbar){wp.media.frames.mailster_editbar=wp.media({title:A.l10n.campaigns.select_image,library:{type:"image"},multiple:false});wp.media.frames.mailster_editbar.on("select",function(){var e=wp.media.frames.mailster_editbar.state().get("selection").first().toJSON(),t=q("img").data({id:e.id,name:e.name,src:e.url});te(null,function(){de(null,t)})})}wp.media.frames.mailster_editbar.open()}function a(t){clearTimeout(timeout);timeout=setTimeout(function(){if(!t)return;var e=A.util.trim(t.save());F.element.html(e)},100)}function ae(){T.removeClass("current-"+F.type).hide();Z(false);q("#single-link").hide();A.trigger("refresh");A.trigger("save");return false}e.save=t;e.open=me;e.cancel=w;A.editbar=e;return A}(mailster||{},jQuery,window,document);