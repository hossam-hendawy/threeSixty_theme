mailster=function(s,o,c,l){"use strict";var d=o(".status");s.events.push("documentReady",e);s.events.push("documentReady",function(){o.fn.sortable&&o(".export-order").sortable({connectWith:".export-order",_placeholder:"ui-state-highlight",containment:".export-order-wrap",receive:function(e,t){t.item.find("input").prop("checked",t.item.closest(".export-order").is(".selected"))}}).on("change","input",function(){var e=o(this);e.parent().appendTo(e.is(":checked")?o(".export-order.selected"):o(".export-order.unselected"))})});s.$.document.on("change","#export-subscribers input,#export-subscribers select",e).on("click",".export-order-add",function(){o(".export-order.unselected").find("li").appendTo(".export-order.selected").find("input").prop("checked",true);return false}).on("click",".export-order-remove",function(){o(".export-order.selected").find("li").appendTo(".export-order.unselected").find("input").prop("checked",false);return false}).on("change",'select[name="outputformat"]',function(){o("#csv-separator")[o(this).val()=="csv"?"show":"hide"]()}).on("submit","#export-subscribers",function(){var n=o(this).serialize();s.util.ajax("export_contacts",{data:n,conditions:s.conditions.serialize()},function(e){if(e.success){c.onbeforeunload=function(){return s.l10n.manage.onbeforeunloadexport};var t=o(".performance").val();d.addClass("progress");u(0,t,e.data.count,n)}else{alert(e.data.msg)}},function(e,t,n){alert(t)});return false});function u(n,o,r,i){var e=(new Date).getTime(),a=Math.min(1,o*n/r)*100;d.html(s.util.sprintf(s.l10n.manage.prepare_download,r,""));s.util.ajax("do_export",{limit:o,offset:n,data:i,conditions:s.conditions.serialize()},function(e){var t=a>=100&&e.data.finished;if(e.success){if(!t)u(n+1,o,r,i);d.html(s.util.sprintf(s.l10n.manage.prepare_download,r,Math.ceil(a)+"%"));if(t){c.onbeforeunload=null;d.html(s.l10n.manage.export_finished);d.html(s.util.sprintf(s.l10n.manage.downloading,r));if(e.data.filename){setTimeout(function(){d.removeClass("progress");l.location=e.data.filename},2e3)}}else{d.html(s.util.sprintf(s.l10n.manage.write_file,e.data.total,Math.ceil(a)+"%"))}}else{c.onbeforeunload=null;d.html(s.l10n.manage.error_export);alert(e.data.msg)}},function(e,t,n){})}s.events.push("updateConditions",e);function e(){setTimeout(function(){var e=o("#export-subscribers").serialize();o("#export-subscriber-button").prop("disabled",true);s.util.ajax("get_subscriber_count",{data:e,conditions:s.conditions.serialize()},function(e){if(e.success){o("#export-subscriber-button").val(s.util.sprintf(s.l10n.manage.export_n_subscribers,e.data.count_formated)).prop("disabled",!e.data.count)}})},10)}return s}(mailster||{},jQuery,window,document);