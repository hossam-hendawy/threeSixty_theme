mailster=function(l,c,i,e){"use strict";l.conditions=l.conditions||{};function t(i,t){if(!i)return;new IntersectionObserver((i,e)=>{i.forEach(i=>{if(i.intersectionRatio>0){t();e.disconnect()}})}).observe(i)}t(e.querySelector(".mailster-conditions"),n);function n(){var e=c(".mailster-conditions");if(e.data("conditions"))return;e.data("conditions",true);var n=e.find(".mailster-conditions-wrap"),o=e.find(".mailster-condition-group"),a=e.find(".mailster-condition");o.eq(0).appendTo(e.find(".mailster-condition-container"));!l.util.trim(n.html())&&n.empty();e.on("click",".add-condition",function(){var t=o.length,i=o.eq(0).clone();i.removeAttr("id").appendTo(n).data("id",t).show();c.each(i.find("input, select"),function(){var i=c(this),e=i.attr("name");e&&i.attr("name",e.replace(/\[\d+\]/,"["+t+"]")).prop("disabled",false)});i.find(".condition-field").val("").focus();o=e.find(".mailster-condition-group");a=e.find(".mailster-condition")}).on("click",".add-or-condition",function(){var t=c(this).parent(),n=t.find(".mailster-condition").last().data("id"),i=a.eq(0).clone();i.removeAttr("id").appendTo(t).data("id",++n);c.each(i.find("input, select"),function(){var i=c(this),e=i.attr("name");e&&i.attr("name",e.replace(/\[\d+\]\[\d+\]/,"["+t.data("id")+"]["+n+"]")).prop("disabled",false)});i.find(".condition-field").val("").focus();a=e.find(".mailster-condition")});n.on("click",".remove-condition",function(){var i=c(this).parent();if(i.parent().find(".mailster-condition").length==1){i=i.parent()}i.slideUp(100,function(){c(this).remove();l.trigger("updateConditions")})}).on("change",".condition-field",function(){var i=c(this).closest(".mailster-condition"),e=c(this).val(),t,n;i.find("div.mailster-conditions-value-field").removeClass("active").find(".condition-value").prop("disabled",true);i.find("div.mailster-conditions-operator-field").removeClass("active").find(".condition-operator").prop("disabled",true);t=i.find('div.mailster-conditions-operator-field[data-fields*=",'+e+',"]').addClass("active").find(".condition-operator").prop("disabled",false);if(!t.length){t=i.find("div.mailster-conditions-operator-field").eq(0).addClass("active").find(".condition-operator").prop("disabled",false)}n=i.find('div.mailster-conditions-value-field[data-fields*=",'+e+',"]').addClass("active").find(".condition-value").prop("disabled",false);if(!n.length){n=i.find("div.mailster-conditions-value-field").eq(0).addClass("active").find(".condition-value").prop("disabled",false)}l.trigger("updateConditions")}).on("focus","input.condition-value",function(){var i=c(this).parent().parent().parent().find(".condition-field").val();var e=c(this);s(i,e)}).on("focus","input.token-helper",function(){var i=c(this).parent().parent().parent().find(".condition-field").val();var e=c(this);s(i,e)}).on("change","input.token-helper",function(){var i=c(this);var e=i.val().split(",");var t=i.next(".token-helper-fields");var n=i.prev(".condition-value").attr("name");var o="";for(var a=0;a<e.length;a++){if(!e[a].trim())continue;o+=l.util.sprintf('<input type="hidden" name="%s" class="condition-value" value="%s">',n,e[a].trim())}t.html(o);l.trigger("updateConditions")}).on("change",".relative-datepicker",function(){var i=c(this).closest(".mailster-conditions-value-field");var e=i.find("input.relative-datepicker").val()*-1;var t=i.find("select.relative-datepicker").val();i.find("input.datepicker").val(e+" "+t);l.trigger("updateConditions")}).on("change",".condition-operator",function(){l.trigger("updateConditions")}).on("change",".mailster-conditions-operator-field-date_operators .condition-operator",function(){var i=c(this).val(),e=/(is_older|is_younger)/.test(i),t=c(this).closest(".mailster-condition").toggleClass("is-relative",e).find(".mailster-conditions-value-field.active").find(".condition-value"),n=t.val();if(e){t.attr("type","text");var o=d(n);t.next("input.relative-datepicker").val(o[0]).next("select.relative-datepicker").val(o[1]).trigger("change")}else{t.attr("type","date");if(!n.match(/^(\d{4})-(\d{2})-(\d{2})$/))t.val((new Date).toISOString().slice(0,10))}}).on("change",".condition-value",function(){l.trigger("updateConditions")}).on("click",".mailster-condition-add-multiselect",function(){c(this).parent().clone().insertAfter(c(this).parent()).find(".condition-value").select().focus();return false}).on("click",".mailster-condition-remove-multiselect",function(){c(this).parent().remove();l.trigger("updateConditions");return false}).on("change",".mailster-conditions-value-field-multiselect > .condition-value",function(){if(0==c(this).val()&&c(this).parent().parent().find(".condition-value").size()>1)c(this).parent().remove()}).on("click",".mailster-rating > span",function(i){var e=c(this),t=e.prevAll(),n=e.siblings();n.removeClass("enabled");t.add(e).addClass("enabled");e.parent().parent().find(".condition-value").val((t.length+1)/5).trigger("change")}).find(".condition-field").prop("disabled",false).trigger("change");l.trigger("updateConditions");n.find(".is-relative").each(function(){var i=d(c(this).find(".mailster-conditions-value-field.active .condition-value").val());c(this).find("input.relative-datepicker").val(i[0]).next("select.relative-datepicker").val(i[1])})}function o(i){var e=[],o=[],t=c("#list-checkboxes").find("input, select"),n=c("#list-checkboxes").find("input.list"),a=c("#list_extra"),r={},d=c(".mailster-conditions-wrap > .mailster-condition-group"),s=0;c.each(n,function(){var i=c(this).val();if(c(this).is(":checked"))e.push(i)});r.id=l.campaign_id;r.lists=e;r.ignore_lists=c("#ignore_lists").is(":checked");c.each(d,function(){var i=c(this).find(".mailster-condition");c.each(i,function(){var i=c(this),e,t=i.find(".condition-field").val(),n=i.find(".mailster-conditions-operator-field.active").find(".condition-operator").val();if(!n||!t)return;e=i.find(".mailster-conditions-value-field.active").find(".condition-value").not(".skip-value").map(function(){return c(this).val()}).toArray();if(e.length==1){e=e[0]}if(!o[s]){o[s]=[]}o[s].push({field:t,operator:n,value:e})});s++});r.operator=c("select.mailster-list-operator").val();r.conditions=o;if(i){r=c.extend(i,r)}return r}function a(i){var e=o();return r(e.conditions,i||"conditions")}function r(i,e){var t=[],n;for(n in i){if(i.hasOwnProperty(n)){var o=e?e+"["+n+"]":n,a=i[n];t.push(a!==null&&typeof a==="object"?r(a,o):encodeURIComponent(o)+"="+encodeURIComponent(a))}}return t.join("&")}function d(i){if(!isNaN(parseFloat(i))&&isFinite(i)){return i}var e;if(e=i.match(/^(\d{4})-(\d{2})-(\d{2})$/)){var t=new Date;t.setHours(0,0,0,0);i=t.getTime()-new Date(e[1],e[2]-1,e[3]).getTime();i=Math.abs(i)/1e3;i=Math.round(i);if(!i){return[1,"days"]}if(!(i/2628e3%1)){i=[i/2628e3,"months"]}else if(!(i/604800%1)){i=[i/604800,"weeks"]}else if(!(i/86400%1)){i=[i/86400,"days"]}else if(!(i/3600%1)){i=[i/3600,"hours"]}else if(!(i/60%1)){i=[Math.ceil(i/60),"minutes"]}}else{i=i.split(" ")}i[0]=Math.abs(i[0]);return i}function s(t,n){var o=n.data("token");if(n.data("ui-autocomplete")!=undefined){n.autocomplete("destroy")}function a(i){if(!o){return i}return i.split(/,\s*/).pop()}function r(i,e){if(!o){return e}var t=i.split(/,\s*/);t.pop();t.push(e);t.push("");return l.util.unique(t).join(", ")}n.autocomplete({classes:{"ui-autocomplete":"mailster-condition-autocomplete"},source:function(i,e){n.addClass("autocomplete-loading");l.util.ajax("get_autocomplete_source",{field:t,search:a(i.term)},function(i){if(i.success){e(i.data)}n.removeClass("autocomplete-loading")})},select:function(i,e){this.value=r(this.value,e.item.value);return false}})}l.conditions.get=o;l.conditions.serialize=a;l.conditions.init=n;return l}(mailster||{},jQuery,window,document);